import{j as e}from"./mui-vendor-C1i-sMyb.js";import{a as t}from"./react-vendor-ClEFeRSO.js";import{o as n,O as i,S as o,B as s,p as r,T as a,M as l,h as c,F as d,G as u,V as h,c as g,k as f,l as p,m as w,Q as y,C as m}from"./three-vendor-BMDtE1KG.js";import"./chart-vendor-DXktVALM.js";const b={core:"#ffffff",firewall:"#e55353",router:"#f6a609",l3switch:"#f6a609",switchrouter:"#f6a609",layer3:"#f6a609",switch:"#3fb950",hub:"#26c6da",server:"#6aa7ff",host:"#6aa7ff",default:"#a0b4ff"};function k({zone:k,staticData:S,onBack:v,onInspectorChange:_,setEventLogs:x}){const D=t.useRef(),j=t.useRef(null),[z,I]=t.useState({nodes:[],links:[]}),[C,L]=t.useState(!1),[P,M]=t.useState(null),[O,E]=t.useState({width:0,height:0});t.useEffect(()=>{if(null==k)return;let e=!0;return(async()=>{try{L(!0);const t=S||await fetch(`http://localhost:8000/neo4j/nodes?activeView=zone${k}&includeIsolated=true`).then(e=>e.json()),n=new Map,i=[];t.forEach(e=>{e.src_IP?.id&&n.set(String(e.src_IP.id),e.src_IP),e.dst_IP?.id&&n.set(String(e.dst_IP.id),e.dst_IP),e.edge?.sourceIP&&e.edge?.targetIP&&i.push({source:String(e.edge.sourceIP),target:String(e.edge.targetIP),...e.edge})});const o=new Set([...n.keys()]),s=i.filter(e=>o.has(e.source)&&o.has(e.target)),r=new Set,a=[];for(const e of s){const t=String(e.source),n=String(e.target),i=t<n?`${t}__${n}__${e.type||""}`:`${n}__${t}__${e.type||""}`;r.has(i)||(r.add(i),a.push(e))}const l=Array.from(n.values()).map(e=>{const t=(e.kind||e.type||"host").toLowerCase(),n=e.label||e.ip||String(e.id),i=e.color||b[t]||b.default,o=e.status||"up",s=e.subnet?e.subnet:"string"==typeof e.ip&&e.ip.includes(".")?e.ip.split(".").slice(0,3).join(".")+".0/24":"unknown/24",r=Number.isFinite(e.zone)?e.zone:null;return{...e,id:String(e.id),kind:t,label:n,color:i,status:o,subnet:s,zone:r}});e&&I({nodes:l,links:a})}catch(t){e&&I({nodes:[],links:[]})}finally{e&&L(!1)}})(),()=>{e=!1}},[k,S]);const A=t.useMemo(()=>({torus:new a(7,1.6,16,32),cone:new r(4.2,9,10),cylinder:new n(4.2,4.2,8,18),box:new s(8.2,2.6,6.2),l3top:new n(2.8,2.8,2.2,16),sphere:new o(3,16,16),led:new o(.7,8,8),hit:new o(7,8,8),octa:new i(4.2,0),dashUnit:new n(1,1,1,10)}),[]),$=t.useMemo(()=>({base:new Map,highlight:new l({color:16767609,metalness:.25,roughness:.72}),dim:new l({color:3293269,metalness:.25,roughness:.72}),ledUp:new c({color:65433}),ledDown:new c({color:16724821}),hit:new c({opacity:0,transparent:!0,depthWrite:!1}),dashedBase:new l({color:8891132,metalness:.15,roughness:.6,transparent:!0,opacity:.98,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1}),dashedInc:new l({color:3829730,metalness:.2,roughness:.55,transparent:!0,opacity:1,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1})}),[]);function B(e){try{e.renderOrder=10,e.material&&(e.material.depthWrite=!1,e.material.polygonOffset=!0,e.material.polygonOffsetFactor=-1)}catch(t){}}function T(e,t,n,i){const o=(new h).subVectors(n,t),s=o.length();if(s<1e-6)return void(e.visible=!1);e.visible=!0;const r=(new h).addVectors(t,n).multiplyScalar(.5);e.position.copy(r),e.quaternion.setFromUnitVectors(new h(0,1,0),o.clone().normalize()),e.scale.set(i,s,i)}const V=e=>{e=String(e||"");let t=0;for(let n=0;n<e.length;n++)t=131*t+e.charCodeAt(n)>>>0;return t};function F(e,t){const n=e.source&&"object"==typeof e.source?e.source:z.nodes.find(t=>String(t.id)===String(e.source)),i=e.target&&"object"==typeof e.target?e.target:z.nodes.find(t=>String(t.id)===String(e.target));if(!n||!i)return void(t.visible=!1);const o=new h(n.x||0,n.y||0,n.z||0),s=new h(i.x||0,i.y||0,i.z||0),r=e=>{if(!e)return 3;const t=e.__deg||0;return 3*("core"===e.kind?1.4:Math.max(.9,Math.min(1.8,.95+.06*t)))},a=r(n),l=r(i),c=(new h).subVectors(s,o),d=c.length()||1,u=c.clone().normalize(),f=function(e,t,n=.12,i=0){const o=(new h).subVectors(t,e),s=o.length()||1,r=(new h).addVectors(e,t).multiplyScalar(.5),a=Math.abs(o.x)<.9?new h(1,0,0):new h(0,1,0),l=(new h).crossVectors(o,a).normalize();l.applyAxisAngle(o.clone().normalize(),i);const c=n*s*2,d=l.multiplyScalar(c).add(r);return new y(e,d,t)}(o.clone().add(u.clone().multiplyScalar(Math.min(a,.4*d))),s.clone().add(u.clone().multiplyScalar(-Math.min(l,.4*d))),.12,function(e){return(V(W(e.source))+V(W(e.target)))%628/100}(e));!function(e,t,n,i,o){e.userData.dashes||(e.userData.dashes=[]);const s=e.userData.dashes;for(;s.length<16;){const t=new g(n,i);t.castShadow=!1,t.receiveShadow=!1,s.push(t),e.add(t)}for(;s.length>16;){const t=s.pop();e.remove(t),t.geometry?.dispose?.()}e.userData.matBase=i,e.userData.matInc=o}(t,0,A.dashUnit,$.dashedBase,$.dashedInc);const p=!(!P||W(e.source)!==P.id&&W(e.target)!==P.id),w=p?2.8:1.35,m=p?t.userData.matInc:t.userData.matBase,b=1/192,k=Math.min(.08,Math.max(.02,(a+l)/(4*d)));for(let h=0;h<16;h++){const e=h/16,n=Math.min(1,e+.03625),i=Math.max(0+k,e+b),o=Math.min(1-k,n-b);if(o<=i){const e=t.userData.dashes[h];e&&(e.visible=!1);continue}const s=f.getPoint(i),r=f.getPoint(o),a=t.userData.dashes[h];a&&(a.material=m,T(a,s,r,Math.max(.2,w)),B(a))}t.visible=!0}const R=t.useMemo(()=>{const e=new Map;return z.links.forEach(t=>{const n=t.source,i=t.target;e.has(n)||e.set(n,new Set),e.has(i)||e.set(i,new Set),e.get(n).add(i),e.get(i).add(n)}),e},[z]),W=e=>e&&"object"==typeof e?e.id??e.__id??String(e):String(e),U=e=>P&&(W(e.source)===P.id||W(e.target)===P.id);return t.useEffect(()=>{if(!P||!x)return;const e=R.get(P.id)||new Set,t=Array.from(e).map(e=>{const t=z.nodes.find(t=>t.id===e);return t?.ip}).filter(e=>e),n=z.links.filter(e=>{const t="object"==typeof e.source?e.source.id:e.source,n="object"==typeof e.target?e.target.id:e.target;return t===P.id||n===P.id}).map(e=>{const t="object"==typeof e.source?e.source.id:e.source,n="object"==typeof e.target?e.target.id:e.target,i=z.nodes.find(e=>e.id===t),o=z.nodes.find(e=>e.id===n);return{src_IP:i?{id:i.id,ip:i.ip,subnet:i.subnet,gateway:i.gateway,__labels:[i.kind],__id:i.id,index:i.zone}:null,dst_IP:o?{id:o.id,ip:o.ip,subnet:o.subnet,gateway:o.gateway,__labels:[o.kind],__id:o.id,index:o.zone,__indexColor:o.color,color:o.color}:null,edge:{sourceIP:t,targetIP:n,type:e.type,count:e.count}}}),i=0===n.length?[{src_IP:{id:P.id,ip:P.ip,subnet:P.subnet,gateway:P.gateway,__labels:[P.kind],__id:P.id,index:P.zone},dst_IP:null,edge:null}]:n,o={message:`Zone ${k} - 노드 선택: ${P.label||P.id}`,nodeInfo:{label:P.label,kind:P.kind,ip:P.ip,subnet:P.subnet,zone:P.zone,id:P.id,gateway:P.gateway},connectedCount:e.size,connectedIps:t,dbInfo:i};x([o])},[P,R,z.nodes,z.links,k,x]),t.useEffect(()=>{const e=()=>{try{D.current&&D.current.zoomToFit(600,40)}catch{}};(z.nodes?.length||z.links?.length)&&requestAnimationFrame(e);const t=j.current;let n;return t&&"undefined"!=typeof ResizeObserver?(n=new ResizeObserver(()=>{requestAnimationFrame(e)}),n.observe(t)):window.addEventListener("resize",e),()=>{n&&t&&n.unobserve(t),window.removeEventListener("resize",e)}},[z]),t.useEffect(()=>{const e=j.current;if(!e)return;const t=()=>{try{E({width:e.clientWidth||0,height:e.clientHeight||0})}catch{}};let n;if(t(),"undefined"!=typeof ResizeObserver){n=new ResizeObserver(()=>t());try{n.observe(e)}catch{}}else window.addEventListener("resize",t);return()=>{try{n&&e&&n.unobserve(e)}catch{}window.removeEventListener("resize",t)}},[]),e.jsx("div",{style:{width:"100%",height:"100%",background:"transparent",padding:0},children:e.jsxs("div",{style:{flex:1,position:"relative",background:"#f0edfd",borderRadius:12,overflow:"hidden",height:"100%"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:14,padding:24},children:[e.jsx("button",{onClick:v,style:{background:"transparent",border:"none",color:"#93c5fd",cursor:"pointer",fontSize:14},children:"← Back"}),e.jsx("h2",{style:{fontSize:22,fontWeight:700,margin:0,color:"#000000ff"},children:`Zone ${k}`}),e.jsx("div",{style:{color:"#cbd5e1"},children:C?"Loading…":`${z.nodes.length} nodes • ${z.links.length} links`})]}),e.jsx("div",{ref:j,style:{height:"calc(100% - 80px)",position:"relative"},children:e.jsx(d,{ref:D,graphData:z,backgroundColor:"#f0edfd",width:O.width,height:O.height,nodeLabel:null,nodeThreeObject:function(e){const t=new u,n=e.color||"#a0b4ff",i=P?(o=e,P&&(o.id===P.id||R.get(P.id)?.has(o.id))?$.highlight:$.dim):(e=>{let t=$.base.get(e);return t||(t=new l({color:new m(e),metalness:.25,roughness:.72}),$.base.set(e,t)),t})(n);var o;let s;if("core"===e.kind)s=new g(A.torus,i);else if("firewall"===e.kind)s=new g(A.cone,i);else if("router"===e.kind)s=new g(A.cylinder,i);else if("switch"===e.kind||"l2switch"===e.kind)s=new g(A.box,i);else if("l3switch"===e.kind||"switchrouter"===e.kind||"layer3"===e.kind){const e=new g(A.box,i),t=new g(A.l3top,i);t.position.y=2.6;const n=new u;n.add(e),n.add(t),s=n}else s="hub"===e.kind?new g(A.octa,i):new g(A.sphere,i);const r=1.7*("core"===e.kind?1.4:Math.max(.9,Math.min(1.8,.95+.06*(e.__deg||0))));s.scale.set(r,r,r),s.castShadow=!0,s.receiveShadow=!0,t.add(s);const a=new g(A.led,"up"===e.status?$.ledUp:$.ledDown);a.position.set(0,"core"===e.kind?13.6:6*r,0),t.add(a);const c=new g(A.hit,$.hit);if(c.name="hit-proxy",t.add(c),e.ip){const n=document.createElement("canvas"),i=n.getContext("2d");i.font="bold 18px Arial";const o=e.ip,s=i.measureText(o).width;n.width=s+16,n.height=32,i.font="bold 18px Arial",i.fillStyle="#222",i.fillRect(0,0,n.width,n.height),i.fillStyle="#fff",i.textAlign="center",i.textBaseline="middle",i.fillText(o,n.width/2,n.height/2);const a=new f(n),l=new p({map:a,transparent:!0}),c=new w(l);c.scale.set(n.width/10*1.7,n.height/10*1.7,1),c.position.set(0,"core"===e.kind?15:10*r,0),t.add(c)}return t},nodeThreeObjectExtend:!0,linkThreeObject:function(e){if("logical"!==String(e.type||"").toLowerCase())return;const t=new u;return t.userData={type:"logical-dashed",link:e,dashes:[]},t},linkThreeObjectExtend:!1,linkColor:e=>"logical"===String(e.type||"").toLowerCase()?P&&U(e)?"#3a6fe2":"#87aafc":P?U(e)?"#1e40af":"#000000ff":"#6b7280",linkOpacity:e=>"logical"===String(e.type||"").toLowerCase()?P&&U(e)?1:.35:P?U(e)?.95:.08:.35,linkWidth:e=>"logical"===String(e.type||"").toLowerCase()?0:P?U(e)?6:.5:1.2,linkDirectionalParticles:e=>"logical"===String(e.type||"").toLowerCase()?0:P&&U(e)?4:0,linkDirectionalParticleWidth:e=>"logical"===String(e.type||"").toLowerCase()?0:P&&U(e)?5:0,linkDirectionalParticleSpeed:e=>"logical"===String(e.type||"").toLowerCase()?0:P&&U(e)?.006:0,linkDirectionalParticleColor:e=>"logical"===String(e.type||"").toLowerCase()?"#000000":P&&U(e)?"#00e5ff":"#000000",linkDirectionalArrowLength:e=>"logical"===String(e.type||"").toLowerCase()?0:P&&U(e)?6:0,linkDirectionalArrowRelPos:.6,linkDirectionalArrowColor:e=>"logical"===String(e.type||"").toLowerCase()?"#000000":P&&U(e)?"#00e5ff":"#000000",linkLabel:e=>{const t=W(e.source),n=W(e.target),i=z.nodes.find(e=>e.id===t),o=z.nodes.find(e=>e.id===n);return`IP: ${i&&i.ip||t} → ${o&&o.ip||n}`},enableNodeDrag:!1,showNavInfo:!1,cooldownTicks:60,d3AlphaDecay:.028,d3VelocityDecay:.35,style:{height:"100%",width:"100%"},onNodeClick:M,onBackgroundClick:()=>{M(null),x&&x([])},onLinkClick:e=>{const t=W(e.source),n=z.nodes.find(e=>e.id===t)||z.nodes[0];n&&M(n)},onLinkUpdate:(e,t)=>{try{const n=e.__lineObj||t;n&&n.computeLineDistances&&n.computeLineDistances()}catch{}},onEngineTick:()=>{const e=D.current?.scene?.();e&&e.traverse(e=>{"logical-dashed"===e.userData?.type&&e.userData.link&&F(e.userData.link,e)})},onEngineStop:()=>{const e=D.current?.scene?.();e&&e.traverse(e=>{"logical-dashed"===e.userData?.type&&e.userData.link&&(F(e.userData.link,e),e.visible=!0)})}})})]})})}export{k as default};
