import{j as e,o as t,t as o,I as s,a5 as n,a6 as r}from"./mui-vendor-Cx2AKDA_.js";import{a,f as i}from"./react-vendor-DGL7KyM8.js";import{D as c}from"./vis-vendor-fIGJlaaL.js";import{N as l}from"./vis-network-CqERLR1V.js";import{C as d}from"./ConsoleView-B1YLTX6c.js";import{u as f,f as u}from"./index-DbDI4epi.js";import"./chart-vendor-DPhWNalc.js";import"./three-vendor-4AZqXyaM.js";const h=({open:t=!0,isPopup:o=!1})=>e.jsx(d,{type:"treatAnalysis",open:t,isPopup:o});function p({deviceElementId:i,onSelectDevice:d}){const p=a.useRef(null),m=a.useRef(null),[g,v]=a.useState({nodes:[],edges:[]}),[x,b]=a.useState(!1),j=a.useRef(null),y=a.useRef(null),[w,N]=a.useState({nodes:[],edges:[]}),[S,I]=a.useState(!1),[k,z]=a.useState(null),{popups:C,openPopup:P,closePopup:A}=f(),R=C.treatAnalysis,[_,E]=a.useState(null),M=i??_;return a.useEffect(()=>{fetch("/neo4j/topology").then(e=>e.json()).then(e=>{v({nodes:e.nodes||[],edges:e.edges||[]})}).catch(console.error)},[]),a.useEffect(()=>{x&&m.current&&(m.current.destroy(),m.current=null)},[x]),a.useEffect(()=>{if(!M)return N({nodes:[],edges:[]}),I(!1),void z(null);I(!0),z(null),fetch(`/neo4j/attack-graph?deviceElementId=${encodeURIComponent(M)}`).then(e=>e.json()).then(e=>{N({nodes:e.nodes||[],edges:e.edges||[],allStartNodes:new Set(e.allStartNodes||[]),targetNodeId:e.targetNodeId||null}),I(!1)}).catch(e=>{I(!1)})},[M]),a.useEffect(()=>{if(!p.current||x)return;let e,t;m.current&&(m.current.destroy(),m.current=null),e=g.nodes.map(e=>{const t=M&&e.elementId===M;return{...e,size:t?20:12,color:t?{background:"#FFCC00",border:"#CC9900"}:{background:"#2B7CE9",border:"#205AAA"}}}),t=g.edges;const o=new c(e),s=new c(t),n={nodes:o,edges:s};return m.current=new l(p.current,n,{interaction:{hover:!0,multiselect:!1},nodes:{font:{color:"#39306b",size:20}},physics:{stabilization:!0},autoResize:!0,height:"100%",width:"100%"}),m.current.on("selectNode",e=>{const t=e.nodes&&e.nodes[0];if(!t)return;const s=o.get(t);if(null!=k&&w.allStartNodes?.has(t))z(t);else if(!k){const e=s&&s.elementId;d&&"function"==typeof d?d(e):E(e)}}),()=>{m.current&&(m.current.destroy(),m.current=null)}},[g,M,d,x,k,w]),a.useEffect(()=>{if(!j.current)return;y.current&&(y.current.destroy(),y.current=null);let e=w.nodes||[],t=w.edges||[],o=!1;if(null!=k&&w.pathsMap){const s=w.pathsMap.get(k);if(s&&s.size>0){o=!0;const n=new Set;n.add(k),n.add(w.targetNodeId);const r=[];for(const e of w.edges||[])s.has(e.id)&&(n.add(e.from),n.add(e.to),r.push(e));const a=new Map,i=[[w.targetNodeId,0]],c=new Set;for(;i.length>0;){const[e,t]=i.shift();if(!c.has(e)){c.add(e),a.set(e,t);for(const o of r)o.from!==e||c.has(o.to)?o.to!==e||c.has(o.from)||i.push([o.from,t+1]):i.push([o.to,t+1])}}t=r.map(e=>{const t=a.get(e.from)??1/0,o=a.get(e.to)??1/0;let s=e.from,n=e.to;return t<o&&(s=e.to,n=e.from),{id:e.id,from:s,to:n,arrows:"to",color:{color:"#FFD700"},width:3,title:e.title}}),e=e.filter(e=>n.has(e.id)).map(e=>e.id===k?{...e,color:{background:"#FFA500",border:"#FF8C00"},size:25}:e)}}const s=new c(e),n=new c(t),r={nodes:s,edges:n},a={interaction:{hover:!0,multiselect:!1},nodes:{font:{color:"#39306b"}},autoResize:!0,height:"100%",width:"100%",...o?{layout:{hierarchical:{enabled:!0,direction:"DU",sortMethod:"directed",levelSeparation:150,nodeSpacing:100}}}:{},physics:{enabled:!o,stabilization:{iterations:200},barnesHut:{gravitationalConstant:-8e3,springConstant:.04,springLength:95}}};return y.current=new l(j.current,r,a),y.current.on("selectNode",e=>{const t=e.nodes&&e.nodes[0];if(!t)return;const o=s.get(t);o&&("StartPhysical"===o.group||w.allStartNodes?.has(t))&&z(t)}),()=>{y.current&&(y.current.destroy(),y.current=null)}},[w,k]),a.useEffect(()=>{if(!j.current)return;const e=j.current,t=new ResizeObserver(e=>{const t=e[0]?.contentRect;if(t&&y.current){const e=Math.max(1,Math.floor(t.width)),o=Math.max(1,Math.floor(t.height));try{y.current.setSize(`${e}px`,`${o}px`),y.current.redraw()}catch{}}});return t.observe(e),()=>{try{t.disconnect()}catch{}}},[w,k]),a.useEffect(()=>{if(x||!p.current)return;const e=p.current,t=new ResizeObserver(e=>{const t=e[0]?.contentRect;if(t&&m.current){const e=Math.max(1,Math.floor(t.width)),o=Math.max(1,Math.floor(t.height));try{m.current.setSize(`${e}px`,`${o}px`),m.current.redraw()}catch{}}});return t.observe(e),()=>{try{t.disconnect()}catch{}}},[x,g]),e.jsx(t,{sx:{width:"100%",height:"calc(100vh - 120px)"},children:e.jsxs(o,{sx:{p:0,height:"100%","&:last-child":{pb:0},position:"relative"},children:[e.jsx("div",{className:"offensive-root",children:e.jsxs("div",{className:"offensive-main",children:[e.jsxs("div",{className:"offensive-attack",children:[e.jsxs("div",{className:"offensive-attack-header",children:[e.jsx("div",{children:S?"Loading attack graph...":M?`Attack target: ${M}${k?" (Start node selected)":""}`:"No attack target selected"}),k&&e.jsx("button",{onClick:()=>z(null),className:"offensive-btn offensive-btn-small",children:"Show All Start Nodes"})]}),e.jsx("div",{ref:j,className:"offensive-attack-canvas"})]}),x?e.jsx("div",{className:"offensive-topology-minimized",children:e.jsxs("button",{onClick:()=>b(!1),className:"offensive-btn",children:["+ ",k?"Attack Path":"Topology"]})}):e.jsxs("div",{className:"offensive-topology",children:[e.jsxs("div",{className:"offensive-topology-header",children:[e.jsx("span",{className:"offensive-topology-title",children:k?"Attack Path":"Device Topology"}),e.jsx("button",{onClick:()=>b(!0),className:"offensive-btn-topology",children:"-"})]}),e.jsx("div",{ref:p,className:"offensive-topology-canvas"})]})]})}),e.jsx(s,{size:"small","aria-label":"위험 노출도 및 공격 가능도 측정",title:"위험 노출도 및 공격 가능도 측정",onClick:()=>P("treatAnalysis"),sx:{position:"absolute",bottom:40,right:40,zIndex:1e3,bgcolor:"rgba(124,58,237,0.8)",color:"#fff",borderRadius:"50%",width:48,height:48,boxShadow:"0 4px 12px rgba(124,58,237,0.5)","&:hover":{bgcolor:"#9333ea",color:"#fff",transform:"scale(1.1)"},transition:"all 0.3s ease"},children:e.jsx(u,{style:{fontSize:24}})}),e.jsxs(n,{open:R,onClose:()=>A("treatAnalysis"),maxWidth:"md",fullWidth:!0,PaperProps:{sx:{height:"70vh",maxHeight:"70vh",m:0,position:"relative",overflow:"hidden"}},children:[e.jsx(s,{onClick:()=>A("treatAnalysis"),sx:{position:"absolute",right:23,top:8.5,color:"#000000ff",zIndex:1,bgcolor:"#cac7d4ff","&:hover":{bgcolor:"#39306b",color:"#ffffffff"}},children:"✕"}),e.jsx(r,{sx:{p:0,height:"100%",overflow:"hidden"},children:e.jsx(h,{open:R,isPopup:!0})})]})]})})}const m=a.memo(()=>{const t=i(),o=t.state?.selectedNode;let s=null;if(o?.dbInfo&&o.dbInfo.length>0){const e=o.dbInfo[0];s=e.dst_IP?.__element_id||e.dst_IP?.id||e.src_IP?.__element_id||e.src_IP?.id}return s||(s=o?.elementId||o?.__element_id||o?.id),e.jsx(p,{deviceElementId:s})});m.displayName="ResponseEffectVisualization";export{m as default};
