import{j as e,o as t,t as o,I as s,a5 as n,a7 as r}from"./mui-vendor-BCY2i4tN.js";import{a,u as c}from"./react-vendor-D7TXN3SA.js";import{D as i}from"./vis-vendor-fIGJlaaL.js";import{N as l}from"./vis-network-CqERLR1V.js";import{T as d}from"./TreatAnalysis-DMidlvD2.js";import{f}from"./index-CUNAowFP.js";import"./chart-vendor-_i8yG59r.js";import"./three-vendor-C-R8GBcK.js";function u({deviceElementId:c,onSelectDevice:u}){const h=a.useRef(null),m=a.useRef(null),[g,p]=a.useState({nodes:[],edges:[]}),[v,x]=a.useState(!1),b=a.useRef(null),j=a.useRef(null),[N,w]=a.useState({nodes:[],edges:[]}),[y,S]=a.useState(!1),[I,k]=a.useState(null),[z,C]=a.useState(!1),[R,_]=a.useState(null),E=c??R;return a.useEffect(()=>{fetch("/neo4j/topology").then(e=>e.json()).then(e=>{p({nodes:e.nodes||[],edges:e.edges||[]})}).catch(console.error)},[]),a.useEffect(()=>{v&&m.current&&(m.current.destroy(),m.current=null)},[v]),a.useEffect(()=>{if(!E)return w({nodes:[],edges:[]}),S(!1),void k(null);S(!0),k(null),fetch(`/neo4j/attack-graph?deviceElementId=${encodeURIComponent(E)}`).then(e=>e.json()).then(e=>{w({nodes:e.nodes||[],edges:e.edges||[],allStartNodes:new Set(e.allStartNodes||[]),targetNodeId:e.targetNodeId||null}),S(!1)}).catch(e=>{S(!1)})},[E]),a.useEffect(()=>{if(!h.current||v)return;let e,t;m.current&&(m.current.destroy(),m.current=null),e=g.nodes.map(e=>{const t=E&&e.elementId===E;return{...e,size:t?20:12,color:t?{background:"#FFCC00",border:"#CC9900"}:{background:"#2B7CE9",border:"#205AAA"}}}),t=g.edges;const o=new i(e),s=new i(t),n={nodes:o,edges:s};return m.current=new l(h.current,n,{interaction:{hover:!0,multiselect:!1},nodes:{font:{color:"#39306b",size:20}},physics:{stabilization:!0},autoResize:!0,height:"100%",width:"100%"}),m.current.on("selectNode",e=>{const t=e.nodes&&e.nodes[0];if(!t)return;const s=o.get(t);if(null!=I&&N.allStartNodes?.has(t))k(t);else if(!I){const e=s&&s.elementId;u&&"function"==typeof u?u(e):_(e)}}),()=>{m.current&&(m.current.destroy(),m.current=null)}},[g,E,u,v,I,N]),a.useEffect(()=>{if(!b.current)return;j.current&&(j.current.destroy(),j.current=null);let e=N.nodes||[],t=N.edges||[],o=!1;if(null!=I&&N.pathsMap){const s=N.pathsMap.get(I);if(s&&s.size>0){o=!0;const n=new Set;n.add(I),n.add(N.targetNodeId);const r=[];for(const e of N.edges||[])s.has(e.id)&&(n.add(e.from),n.add(e.to),r.push(e));const a=new Map,c=[[N.targetNodeId,0]],i=new Set;for(;c.length>0;){const[e,t]=c.shift();if(!i.has(e)){i.add(e),a.set(e,t);for(const o of r)o.from!==e||i.has(o.to)?o.to!==e||i.has(o.from)||c.push([o.from,t+1]):c.push([o.to,t+1])}}t=r.map(e=>{const t=a.get(e.from)??1/0,o=a.get(e.to)??1/0;let s=e.from,n=e.to;return t<o&&(s=e.to,n=e.from),{id:e.id,from:s,to:n,arrows:"to",color:{color:"#FFD700"},width:3,title:e.title}}),e=e.filter(e=>n.has(e.id)).map(e=>e.id===I?{...e,color:{background:"#FFA500",border:"#FF8C00"},size:25}:e)}}const s=new i(e),n=new i(t),r={nodes:s,edges:n},a={interaction:{hover:!0,multiselect:!1},nodes:{font:{color:"#39306b"}},autoResize:!0,height:"100%",width:"100%",...o?{layout:{hierarchical:{enabled:!0,direction:"DU",sortMethod:"directed",levelSeparation:150,nodeSpacing:100}}}:{},physics:{enabled:!o,stabilization:{iterations:200},barnesHut:{gravitationalConstant:-8e3,springConstant:.04,springLength:95}}};return j.current=new l(b.current,r,a),j.current.on("selectNode",e=>{const t=e.nodes&&e.nodes[0];if(!t)return;const o=s.get(t);o&&("StartPhysical"===o.group||N.allStartNodes?.has(t))&&k(t)}),()=>{j.current&&(j.current.destroy(),j.current=null)}},[N,I]),a.useEffect(()=>{if(!b.current)return;const e=b.current,t=new ResizeObserver(e=>{const t=e[0]?.contentRect;if(t&&j.current){const e=Math.max(1,Math.floor(t.width)),o=Math.max(1,Math.floor(t.height));try{j.current.setSize(`${e}px`,`${o}px`),j.current.redraw()}catch{}}});return t.observe(e),()=>{try{t.disconnect()}catch{}}},[N,I]),a.useEffect(()=>{if(v||!h.current)return;const e=h.current,t=new ResizeObserver(e=>{const t=e[0]?.contentRect;if(t&&m.current){const e=Math.max(1,Math.floor(t.width)),o=Math.max(1,Math.floor(t.height));try{m.current.setSize(`${e}px`,`${o}px`),m.current.redraw()}catch{}}});return t.observe(e),()=>{try{t.disconnect()}catch{}}},[v,g]),e.jsx(t,{sx:{width:"100%",height:"calc(100vh - 120px)"},children:e.jsxs(o,{sx:{p:0,height:"100%","&:last-child":{pb:0},position:"relative"},children:[e.jsx("div",{className:"offensive-root",children:e.jsxs("div",{className:"offensive-main",children:[e.jsxs("div",{className:"offensive-attack",children:[e.jsxs("div",{className:"offensive-attack-header",children:[e.jsx("div",{children:y?"Loading attack graph...":E?`Attack target: ${E}${I?" (Start node selected)":""}`:"No attack target selected"}),I&&e.jsx("button",{onClick:()=>k(null),className:"offensive-btn offensive-btn-small",children:"Show All Start Nodes"})]}),e.jsx("div",{ref:b,className:"offensive-attack-canvas"})]}),v?e.jsx("div",{className:"offensive-topology-minimized",children:e.jsxs("button",{onClick:()=>x(!1),className:"offensive-btn",children:["+ ",I?"Attack Path":"Topology"]})}):e.jsxs("div",{className:"offensive-topology",children:[e.jsxs("div",{className:"offensive-topology-header",children:[e.jsx("span",{className:"offensive-topology-title",children:I?"Attack Path":"Device Topology"}),e.jsx("button",{onClick:()=>x(!0),className:"offensive-btn-topology",children:"-"})]}),e.jsx("div",{ref:h,className:"offensive-topology-canvas"})]})]})}),e.jsx(s,{size:"small","aria-label":"위험 노출도 및 공격 가능도 측정",title:"위험 노출도 및 공격 가능도 측정",onClick:()=>C(!0),sx:{position:"absolute",bottom:40,right:40,zIndex:1e3,bgcolor:"rgba(124,58,237,0.8)",color:"#fff",borderRadius:"50%",width:48,height:48,boxShadow:"0 4px 12px rgba(124,58,237,0.5)","&:hover":{bgcolor:"#9333ea",color:"#fff",transform:"scale(1.1)"},transition:"all 0.3s ease"},children:e.jsx(f,{style:{fontSize:24}})}),e.jsxs(n,{open:z,onClose:()=>C(!1),maxWidth:"md",fullWidth:!0,PaperProps:{sx:{height:"70vh",maxHeight:"70vh",m:0,position:"relative",overflow:"hidden"}},children:[e.jsx(s,{onClick:()=>C(!1),sx:{position:"absolute",right:23,top:8.5,color:"#000000ff",zIndex:1,bgcolor:"#cac7d4ff","&:hover":{bgcolor:"#39306b",color:"#ffffffff"}},children:"✕"}),e.jsx(r,{sx:{p:0,height:"100%",overflow:"hidden"},children:e.jsx(d,{open:z,isPopup:!0})})]})]})})}const h=a.memo(()=>{const t=c(),o=t.state?.selectedNode;let s=null;if(o?.dbInfo&&o.dbInfo.length>0){const e=o.dbInfo[0];s=e.dst_IP?.__element_id||e.dst_IP?.id||e.src_IP?.__element_id||e.src_IP?.id}return s||(s=o?.elementId||o?.__element_id||o?.id),e.jsx(u,{deviceElementId:s})});h.displayName="ResponseEffectVisualization";export{h as default};
